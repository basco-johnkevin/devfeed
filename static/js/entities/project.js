// Generated by CoffeeScript 1.6.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(["devfeed"], function(Devfeed) {
    Devfeed.module("Entities", function(Entities, Devfeed, Backbone, Marionette, $, _) {
      var API, projects, _ref, _ref1, _ref2, _ref3;
      Entities.Proj = {};
      Entities.Proj.Story = (function(_super) {
        __extends(Story, _super);

        function Story() {
          _ref = Story.__super__.constructor.apply(this, arguments);
          return _ref;
        }

        Story.prototype.defaults = {
          id: null,
          name: null,
          description: null,
          current_state: null,
          url: null
        };

        return Story;

      })(Backbone.Model);
      Entities.Proj.Stories = (function(_super) {
        __extends(Stories, _super);

        function Stories() {
          _ref1 = Stories.__super__.constructor.apply(this, arguments);
          return _ref1;
        }

        Stories.prototype.model = Entities.Proj.Story;

        return Stories;

      })(Backbone.Collection);
      Entities.Proj.Project = (function(_super) {
        __extends(Project, _super);

        function Project() {
          _ref2 = Project.__super__.constructor.apply(this, arguments);
          return _ref2;
        }

        Project.prototype.defaults = {
          id: null,
          name: null,
          issynced: false,
          stories: [],
          time_zone: null
        };

        Project.prototype.urlRoot = "/api/projects";

        Project.prototype.parse = function(response, options) {
          if (response.s === 200) {
            return response.d;
          }
        };

        Project.prototype.initialize = function() {
          return this.on("change", this.convertRawStories);
        };

        Project.prototype.convertRawStories = function() {
          var rawStories, stories;
          rawStories = this.get("stories");
          if (_.isArray(rawStories)) {
            stories = new Entities.Proj.Stories(rawStories);
            return this.set("stories", stories);
          }
        };

        return Project;

      })(Backbone.Model);
      Entities.Proj.Projects = (function(_super) {
        __extends(Projects, _super);

        function Projects() {
          _ref3 = Projects.__super__.constructor.apply(this, arguments);
          return _ref3;
        }

        Projects.prototype.model = Entities.Proj.Project;

        Projects.prototype.url = "/api/projects";

        Projects.prototype.parse = function(response, options) {
          if (response.s === 200) {
            return response.d;
          }
        };

        return Projects;

      })(Backbone.Collection);
      projects = new Entities.Proj.Projects(((typeof Projects !== "undefined" && Projects !== null) && Projects) || null);
      API = {
        getProject: function(id) {
          var defer, project;
          defer = $.Deferred();
          project = new Entities.Proj.Project({
            id: id
          });
          project.fetch({
            success: function(data) {
              return defer.resolve(data);
            },
            error: function(data) {
              return defer.resolve(void 0);
            }
          });
          return defer.promise();
        },
        getProjects: function() {
          var defer;
          defer = $.Deferred();
          if (projects.length === 0) {
            projects.fetch({
              success: function(collection, response, options) {
                if (response.s === 200) {
                  projects.reset(response.d);
                }
                return defer.resolve(projects);
              },
              error: function(collection, response, options) {
                return defer.resolve(null);
              }
            });
          } else {
            defer.resolve(projects);
          }
          return defer.promise();
        }
      };
      Devfeed.reqres.setHandler("project:entity", function(id) {
        return API.getProject(id);
      });
      return Devfeed.reqres.setHandler("project:entities", function() {
        return API.getProjects();
      });
    });
    return Devfeed.Entities.Proj;
  });

}).call(this);
